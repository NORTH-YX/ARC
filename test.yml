version: 0.1
component: build
timeoutInSeconds: 1800
shell: bash

steps:
  - type: Command
    name: "Install tools"
    command: |
      sudo yum install -y java-17-openjdk wget unzip curl tar

      mkdir -p $HOME/k8s
      cd $HOME/k8s
      wget https://dl.k8s.io/v1.31.2/bin/linux/amd64/kubectl
      chmod +x kubectl

      cd $HOME
      wget https://downloads.apache.org/jmeter/binaries/apache-jmeter-5.6.3.tgz
      tar -xvzf apache-jmeter-5.6.3.tgz

      export PATH=$PATH:$HOME/k8s:$HOME/apache-jmeter-5.6.3/bin

  - type: Command
    name: "Configure Kubeconfig and Get IP"
    command: |
      export PATH=$PATH:$HOME/k8s
      mkdir -p $HOME/.kube
      oci ce cluster create-kubeconfig --cluster-id ocid1.cluster.oc1.mx-queretaro-1.aaaaaaaaxyz123abc... --file $HOME/.kube/config --region mx-queretaro-1 --token-version 2.0.0 --kube-endpoint PUBLIC_ENDPOINT
      export KUBECONFIG=$HOME/.kube/config

      echo "⏳ Esperando 25 segundos..."
      sleep 25

      TARGET_IP=$(kubectl get services --all-namespaces -o jsonpath='{.items[?(@.spec.type=="LoadBalancer")].status.loadBalancer.ingress[0].ip}')
      echo " IP obtenida: $TARGET_IP"
      echo $TARGET_IP > ip.txt

  - type: Command
    name: "Run JMeter test"
    command: |
      export PATH=$PATH:$HOME/apache-jmeter-5.6.3/bin
      export TARGET_IP=$(cat ip.txt)
      echo "Running JMeter against http://$TARGET_IP"
      jmeter -n -t jmeter/test_plan.jmx -Jhost=$TARGET_IP -l jmeter/results.jtl
