version: 0.1
component: build
timeoutInSeconds: 1800
shell: bash

steps:
  - type: Command
    name: "Install tools"
    command: |
      yum install -y java-17-openjdk wget unzip
      wget https://downloads.apache.org//jmeter/binaries/apache-jmeter-5.6.3.tgz
      tar -xvzf apache-jmeter-5.6.3.tgz
      export JMETER_HOME=$PWD/apache-jmeter-5.6.3
      export PATH=$PATH:$JMETER_HOME/bin

      wget https://github.com/zaproxy/zaproxy/releases/download/v2.14.0/ZAP_2.14.0_Linux.tar.gz
      tar -xvzf ZAP_2.14.0_Linux.tar.gz
      export ZAP_HOME=$PWD/ZAP_2.14.0
      export PATH=$PATH:$ZAP_HOME

  - type: Command
    name: "Obtain LoadBalancer IP"
    command: |
      export PATH=$PATH:$HOME/k8s
      export KUBECONFIG=$HOME/.kube/config
      IP=$(kubectl get svc -n default -o jsonpath="{.items[?(@.metadata.name=='todolistapp-springboot-service')].status.loadBalancer.ingress[0].ip}")
      echo "TARGET_IP=$IP" >> $OCI_PRIMARY_BUILD_RUN_ID_env_var_export

  - type: Command
    name: "Run JMeter Test"
    command: |
      source $OCI_PRIMARY_BUILD_RUN_ID_env_var_export
      echo "Testing against http://$TARGET_IP"
      jmeter -n -t jmeter/test_plan.jmx -Jhost=$TARGET_IP -l jmeter/results.jtl

  - type: Command
    name: "Run OWASP ZAP Baseline Scan"
    command: |
      source $OCI_PRIMARY_BUILD_RUN_ID_env_var_export
      echo "Running ZAP scan on http://$TARGET_IP"
      ./ZAP_2.14.0/zap.sh -cmd -quickurl http://$TARGET_IP -quickout zap_report.html
